#!/bin/bash

# 暂时取消 PREFIX 环境变量
OLD_PREFIX=$PREFIX
unset PREFIX

# 加载 NVM
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # 加载 nvm
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # 加载 nvm bash_completion

# 检查 node 命令是否存在
if ! command -v node &> /dev/null; then
    echo "Error: node is not installed or not in PATH"
    # 恢复 PREFIX
    export PREFIX=$OLD_PREFIX
    exit 1
fi

# 设置 PATH
NODE_PATH=$(command -v node)
if [ -n "$NODE_PATH" ]; then
    export PATH="$(dirname "$NODE_PATH"):$PATH"
fi

# 执行命令
node scripts/version-bump.js && \
yarn build && \
npm publish || exit 1

# 执行完成后恢复 PREFIX
export PREFIX=$OLD_PREFIX
